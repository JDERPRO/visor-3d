import"./modulepreload-polyfill-B5Qt9EMX.js";import{B as S,V as x}from"./three-B4arhRS6.js";import{p as D,C as U,s as A,i as O,H as T,d as P,h as $,R as j}from"./thatopen-CwLPH9ho.js";let c=null,r=null,l=null,B=null,p=null,m=null,i=null,b=0;async function q(){try{u("Inicializando motor de conversión..."),g(10),c=new D,r=c.get(U).create(),g(30),u("Configurando escena 3D...");const t=document.getElementById("preview-container");r.scene=new A(c),r.renderer=new O(c,t),r.camera=new T(c),c.init(),r.scene.setup(),r.camera.controls.setLookAt(12,12,12,0,0,0),c.get(P).create(r),g(50),u("Cargando motor IFC (web-ifc WASM)..."),l=c.get($),B=c.get(j),await B.setup(),B.settings.wasm={path:"https://unpkg.com/web-ifc@0.0.55/",absolute:!0},g(90),u("Motor listo."),new ResizeObserver(()=>{r.renderer&&r.renderer.resize()}).observe(t),g(100),setTimeout(()=>{const s=document.getElementById("loading-screen");s&&(s.classList.add("fade-out"),setTimeout(()=>{s.style.display="none"},600))},300),N(),V(),console.log("[Converter] Ready")}catch(e){console.error("[Converter] Boot error:",e),u(`Error: ${e.message}`)}}function u(e){const t=document.getElementById("loading-status");t&&(t.textContent=e)}function g(e){const t=document.getElementById("loading-bar");t&&(t.style.width=`${Math.min(100,Math.max(0,e))}%`)}function N(){const e=document.getElementById("upload-area"),t=document.getElementById("ifc-file-input");let n=0;e.addEventListener("click",()=>t.click()),t.addEventListener("change",o=>{const s=o.target.files[0];s&&k(s),t.value=""}),e.addEventListener("dragenter",o=>{o.preventDefault(),n++,e.classList.add("drag-over")}),e.addEventListener("dragleave",o=>{o.preventDefault(),n--,n<=0&&(n=0,e.classList.remove("drag-over"))}),e.addEventListener("dragover",o=>{o.preventDefault()}),e.addEventListener("drop",o=>{o.preventDefault(),n=0,e.classList.remove("drag-over");const s=o.dataTransfer.files[0];if(s){if(s.name.split(".").pop().toLowerCase()!=="ifc"){L("Solo se aceptan archivos .ifc","error");return}k(s)}}),document.getElementById("btn-remove-file")?.addEventListener("click",z)}function k(e){p=e,m=null,document.getElementById("file-name").textContent=e.name,document.getElementById("file-size").textContent=f(e.size),document.getElementById("upload-section").classList.add("hidden"),document.getElementById("file-info-section").classList.remove("hidden"),document.getElementById("action-section").classList.remove("hidden"),document.getElementById("progress-section").classList.add("hidden"),document.getElementById("result-section").classList.add("hidden"),document.getElementById("error-section").classList.add("hidden"),L(`Archivo "${e.name}" seleccionado`)}function V(){document.getElementById("btn-convert")?.addEventListener("click",F),document.getElementById("btn-download")?.addEventListener("click",W),document.getElementById("btn-preview")?.addEventListener("click",_),document.getElementById("btn-convert-another")?.addEventListener("click",z),document.getElementById("btn-retry")?.addEventListener("click",F)}async function F(){if(p){b=performance.now(),document.getElementById("action-section").classList.add("hidden"),document.getElementById("result-section").classList.add("hidden"),document.getElementById("error-section").classList.add("hidden"),document.getElementById("progress-section").classList.remove("hidden"),G();try{v("step-read"),E("Leyendo archivo IFC..."),a(10);const e=await p.arrayBuffer(),t=new Uint8Array(e);y("step-read",`${f(t.length)} leídos`),a(25),v("step-parse"),E("Parseando geometría IFC con web-ifc..."),a(30),M();const n=await B.load(t);if(!n)throw new Error("El IfcLoader no retornó un modelo válido");r.scene.three.add(n),y("step-parse","Geometría procesada"),a(60),v("step-convert"),E("Convirtiendo a formato Fragments..."),a(70);let o=0,s=0;l.groups.forEach(I=>{s++,o+=I.children?.length||0,I.items&&(o+=I.items.length)}),y("step-convert",`${o} elementos, ${s} fragmentos`),a(80),v("step-export"),E("Exportando archivo .frag..."),a(85);const d=l.export(n);m=d,i=p.name.replace(/\.ifc$/i,".frag"),y("step-export",`${f(d.length)} generados`),a(100),J(n);const w=document.getElementById("preview-overlay"),C=document.getElementById("preview-empty");w&&w.classList.remove("hidden"),C&&C.classList.add("hidden"),document.getElementById("preview-model-name").textContent=i;const R=((performance.now()-b)/1e3).toFixed(1);H(t.length,d.length,o,R),L("¡Conversión completada exitosamente!")}catch(e){console.error("[Converter] Error:",e),K(e.message)}}}function G(){["step-read","step-parse","step-convert","step-export"].forEach(e=>{const t=document.getElementById(e);t&&(t.classList.remove("active","complete","error"),t.querySelector(".step-status").textContent="Pendiente")})}function v(e){const t=document.getElementById(e);t&&(t.classList.add("active"),t.classList.remove("complete","error"),t.querySelector(".step-status").textContent="En progreso...")}function y(e,t){const n=document.getElementById(e);n&&(n.classList.remove("active"),n.classList.add("complete"),n.querySelector(".step-status").textContent=t||"Completado")}function a(e){const t=document.getElementById("conversion-progress");t&&(t.style.width=`${e}%`)}function E(e){const t=document.getElementById("progress-message");t&&(t.textContent=e)}function H(e,t,n,o){document.getElementById("progress-section").classList.add("hidden"),document.getElementById("result-section").classList.remove("hidden"),document.getElementById("result-original-size").textContent=f(e),document.getElementById("result-frag-size").textContent=f(t);const s=e>0?((1-t/e)*100).toFixed(1):"0",d=document.getElementById("result-reduction");d.textContent=`${s}%`,d.className=`stat-value ${parseFloat(s)>0?"stat-success":"stat-warning"}`,document.getElementById("result-elements").textContent=n.toLocaleString(),document.getElementById("result-time").textContent=`${o}s`}function K(e){document.getElementById("progress-section").classList.add("hidden"),document.getElementById("error-section").classList.remove("hidden"),document.getElementById("error-message").textContent=e}function W(){if(!m||!i)return;const e=new Blob([m],{type:"application/octet-stream"}),t=URL.createObjectURL(e),n=document.createElement("a");n.href=t,n.download=i,document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(t),L(`Descargando "${i}"`)}function _(){if(!m||!i)return;const e=new Blob([m],{type:"application/octet-stream"}),t=URL.createObjectURL(e),n=`/?model=${encodeURIComponent(t)}&name=${encodeURIComponent(i)}`;window.open(n,"_blank")}function M(){r?.scene?.three&&(l&&(Array.from(l.groups.values()).forEach(t=>{r.scene.three.remove(t)}),l.dispose()),l=c.get($))}function J(e){if(!e||!r?.camera?.controls)return;const t=new S().setFromObject(e);if(t.isEmpty())return;const n=t.getCenter(new x),o=t.getSize(new x),d=Math.max(o.x,o.y,o.z)*1.5;r.camera.controls.setLookAt(n.x+d*.7,n.y+d*.7,n.z+d*.7,n.x,n.y,n.z,!0)}function z(){p=null,m=null,i=null,document.getElementById("upload-section").classList.remove("hidden"),document.getElementById("file-info-section").classList.add("hidden"),document.getElementById("action-section").classList.add("hidden"),document.getElementById("progress-section").classList.add("hidden"),document.getElementById("result-section").classList.add("hidden"),document.getElementById("error-section").classList.add("hidden"),document.getElementById("preview-overlay")?.classList.add("hidden"),document.getElementById("preview-empty")?.classList.remove("hidden"),M()}function f(e){if(e===0)return"0 B";const t=1024,n=["B","KB","MB","GB"],o=Math.floor(Math.log(e)/Math.log(t));return parseFloat((e/Math.pow(t,o)).toFixed(2))+" "+n[o]}let h=null;function L(e,t="success"){const n=document.getElementById("toast"),o=document.getElementById("toast-message"),s=n?.querySelector(".toast-icon");!n||!o||(h&&clearTimeout(h),o.textContent=e,s&&(s.className=t==="error"?"fas fa-exclamation-circle toast-icon toast-error":"fas fa-check-circle toast-icon"),n.classList.remove("toast-hidden"),h=setTimeout(()=>{n.classList.add("toast-hidden"),h=null},3e3))}document.addEventListener("DOMContentLoaded",q);
